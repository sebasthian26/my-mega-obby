<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mega Obby: Fixed Void Edition</title>
<style>
body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; }
#progress-container {
position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
width: 70%; height: 18px; background: rgba(255,255,255,0.1);
border: 2px solid #00ffcc; border-radius: 10px; overflow: hidden;
}
#progress-bar { width: 0%; height: 100%; background: #00ffcc; }
#stage-info {
position: absolute; top: 20px; left: 20px; color: #00ffcc;
font-weight: bold; font-size: 1.2rem; text-shadow: 2px 2px #000;
}
#ui { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; box-sizing: border-box; pointer-events: none; }
.btn { pointer-events: auto; background: rgba(0,0,0,0.6); border: 3px solid #00ffcc; color: #00ffcc; border-radius: 50%; display: flex; align-items: center; justify-content: center; user-select: none; }
#joystick { width: 110px; height: 110px; position: relative; }
#knob { width: 45px; height: 45px; background: #00ffcc; border-radius: 50%; position: absolute; top: 32px; left: 32px; }
#jump { width: 95px; height: 95px; font-weight: bold; font-size: 1.3rem; }
#win-ui {
position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
background: rgba(0,0,0,0.9); border: 4px solid #00ffcc; color: #00ffcc;
padding: 40px; text-align: center; border-radius: 20px; display: none;
box-shadow: 0 0 50px #00ffcc; z-index: 10;
}
.restart-btn { background:#00ffcc; border:none; padding:15px 30px; font-weight:bold; cursor:pointer; border-radius: 5px; }
</style>
</head>
<body>
<div id="stage-info">STAGE: 1</div>
<div id="progress-container"><div id="progress-bar"></div></div>
<div id="win-ui">
<h1>OBBY CLEARED!</h1>
<button id="restart-trigger" class="restart-btn">RESTART OBBY</button>
</div>
<div id="ui">
<div id="joystick" class="btn"><div id="knob"></div></div>
<div id="jump" class="btn">JUMP</div>
</div>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
import * as THREE from 'three';

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x020205);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 10000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff, 2);
light.position.set(50, 200, 50);
scene.add(light, new THREE.AmbientLight(0x404040));

// --- R6 PLAYER ---
const player = new THREE.Group();
const parts = {};
const colors = { head: 0xE5E11E, torso: 0x0066BB, limbs: 0xE5E11E, legs: 0x4B974B };

const createPart = (w, h, d, x, y, z, name, color) => {
const group = new THREE.Group();
const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({color}));
mesh.position.set(0, -h/2, 0);
group.position.set(x, y, z);
group.add(mesh);
player.add(group);
parts[name] = group;
};
createPart(1.0, 1.2, 0.5, 0, 2.4, 0, 'torso', colors.torso);
createPart(0.6, 0.6, 0.6, 0, 3.0, 0, 'head', colors.head);
createPart(0.5, 1.2, 0.5, -0.75, 2.4, 0, 'lArm', colors.limbs);
createPart(0.5, 1.2, 0.5, 0.75, 2.4, 0, 'rArm', colors.limbs);
createPart(0.5, 1.2, 0.5, -0.25, 1.2, 0, 'lLeg', colors.legs);
createPart(0.5, 1.2, 0.5, 0.25, 1.2, 0, 'rLeg', colors.legs);
scene.add(player);

// --- WORLD GENERATOR ---
const platforms = [];
let currentStage = 1, finishZ = 5000, gameWon = false;
let checkpoint = new THREE.Vector3(0, 5, 0);
let lastSafeY = 5;

function addPart(w, h, d, x, y, z, color, type, stageNum) {
const m = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({color}));
m.position.set(x, y, z);
m.updateMatrixWorld();
scene.add(m);
const box = new THREE.Box3().setFromObject(m);
const obj = { box, type, stage: stageNum, y: m.position.y };
platforms.push(obj);
return obj;
}

addPart(40, 1, 40, 0, 0, 0, 0x333333, 'base', 1);

let curX = 0, curY = 0, curZ = 30;
const stageColors = [0x0066ff, 0xff00ff, 0x00ffcc, 0xffaa00, 0xff3333];

for(let s = 1; s <= 100; s++) {
let color = stageColors[s % stageColors.length];
for(let j = 0; j < 5; j++) {
curX += (Math.random() - 0.5) * 16;
curY += (Math.random() * 2.5);
curZ += 20;
addPart(10, 1, 10, curX, curY, curZ, color, 'plat', s);
}
curZ += 22;
addPart(25, 1, 25, curX, curY, curZ, 0xffff00, 'cp', s + 1);
curZ += 22;
}

finishZ = curZ + 20;
addPart(120, 2, 120, curX, curY, finishZ, 0xffffff, 'goal', 101);

// --- RESTART ---
document.getElementById('restart-trigger').onclick = () => {
player.position.set(0, 5, 0);
checkpoint.set(0, 5, 0);
lastSafeY = 5;
velY = 0; currentStage = 1; gameWon = false;
document.getElementById('stage-info').innerText = "STAGE: 1";
document.getElementById('win-ui').style.display = 'none';
};

// --- PHYSICS ---
let yaw = 0, velY = 0, isGrounded = false, moveDir = {x:0, z:0}, keys = {};
let jumpCount = 0;
const pR = 0.55, pH = 3.0;

const tryJump = () => {
if (isGrounded) { velY = 0.46; jumpCount = 1; }
else if (jumpCount === 1) { velY = 0.40; jumpCount = 2; }
};

const respawn = () => {
player.position.copy(checkpoint);
velY = 0;
jumpCount = 0;
};

window.onkeydown = (e) => { keys[e.key.toLowerCase()] = true; if(e.code === 'Space') tryJump(); };
window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;
renderer.domElement.onclick = () => renderer.domElement.requestPointerLock();
document.addEventListener('mousemove', (e) => { if(document.pointerLockElement) yaw -= e.movementX * 0.003; });

const joy = document.getElementById('joystick'), knob = document.getElementById('knob');
joy.ontouchmove = (e) => {
const r = joy.getBoundingClientRect(), t = e.touches[0];
const dx = Math.max(-45, Math.min(45, t.clientX-(r.left+55))), dy = Math.max(-45, Math.min(45, t.clientY-(r.top+55)));
knob.style.transform = `translate(${dx}px, ${dy}px)`;
moveDir = { x: dx/45, z: dy/45 };
};
joy.ontouchend = () => { knob.style.transform = 'translate(0,0)'; moveDir = {x:0, z:0}; };
document.getElementById('jump').onpointerdown = (e) => { e.preventDefault(); tryJump(); };

function animate() {
requestAnimationFrame(animate);
if(gameWon) return;

let f = (keys.w?1:0)-(keys.s?1:0)-moveDir.z, r = (keys.a?1:0)-(keys.d?1:0)-moveDir.x;
player.position.x += (Math.sin(yaw)*f + Math.cos(yaw)*r) * 0.38;
player.position.z += (Math.cos(yaw)*f - Math.sin(yaw)*r) * 0.38;
if(f!==0 || r!==0) player.rotation.y = yaw + Math.atan2(r, f);

velY -= 0.016; player.position.y += velY;
isGrounded = false;

// VOID CHECK: If you fall 35 units below the last safe height, you die.
if (player.position.y < lastSafeY - 35) {
respawn();
return;
}

const pBox = new THREE.Box3().setFromCenterAndSize(
player.position.clone().add(new THREE.Vector3(0, pH/2, 0)),
new THREE.Vector3(pR*2, pH, pR*2)
);

for(let p of platforms) {
// Optimization: only check platforms in Z-range
if(Math.abs(p.box.min.z - player.position.z) > 40) continue;

if (pBox.intersectsBox(p.box)) {
if (velY <= 0 && player.position.y >= p.box.max.y - 0.9) {
player.position.y = p.box.max.y;
lastSafeY = player.position.y; // Update safe height
velY = 0; isGrounded = true; jumpCount = 0;

if(p.type === 'cp' && p.stage > currentStage) {
checkpoint.set(player.position.x, player.position.y + 2, player.position.z);
currentStage = p.stage;
document.getElementById('stage-info').innerText = "STAGE: " + currentStage;
}
if(p.type === 'goal') { gameWon = true; document.getElementById('win-ui').style.display = 'block'; document.exitPointerLock(); }
break;
}
}
}

// Animations
let time = Date.now() * 0.008;
if (!isGrounded) {
parts.lArm.rotation.x = -2.5; parts.rArm.rotation.x = -2.5;
parts.lLeg.rotation.z = -0.3; parts.rLeg.rotation.z = 0.3;
} else if (f !== 0 || r !== 0) {
const swing = Math.sin(time * 2.2) * 0.8;
parts.lLeg.rotation.x = swing; parts.rLeg.rotation.x = -swing;
parts.lArm.rotation.x = -swing; parts.rArm.rotation.x = swing;
} else {
Object.values(parts).forEach(p => { p.rotation.x *= 0.8; p.rotation.z *= 0.8; });
}

document.getElementById('progress-bar').style.width = (Math.min(player.position.z / finishZ, 1) * 100) + "%";
camera.position.set(player.position.x - Math.sin(yaw)*16, player.position.y + 9, player.position.z - Math.cos(yaw)*16);
camera.lookAt(player.position.x, player.position.y + 2.5, player.position.z);
renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>